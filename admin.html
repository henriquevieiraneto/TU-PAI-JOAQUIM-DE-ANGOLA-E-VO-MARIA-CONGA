<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Master | TU Pai Joaquim</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-box { background: var(--glass); padding: 25px; border-radius: 15px; border: 1px solid var(--glass-border); margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .card-edit { border-left: 5px solid var(--primary-neon); background: rgba(0,0,0,0.4); }
        input { width: 100%; padding: 12px; margin: 5px 0 15px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; font-family: inherit; }
        input:focus { border-color: var(--primary-neon); outline: none; }
        .btn { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; font-family: inherit; }
        .btn-add { background: var(--primary-neon); color: black; margin-bottom: 20px; }
        .btn-add:hover { filter: brightness(1.2); }
        .btn-save { background: #28a745; color: white; font-size: 1.1rem; position: sticky; top: 10px; z-index: 100; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .btn-save:hover { background: #218838; }
        .btn-del { background: #dc3545; color: white; width: auto; padding: 8px 15px; font-size: 0.7rem; float: right; }
        label { font-size: 0.7rem; color: var(--primary-neon); text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        #log { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 25px; background: var(--primary-neon); color: black; border-radius: 50px; display: none; font-weight: bold; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .hidden { display: none; }
        .clearfix::after { content: ""; clear: both; display: table; }
    </style>
</head>
<body>
    <header><h1>GEST√ÉO MASTER DO TERREIRO</h1></header>
    
    <main class="container">
        <div id="login-screen" class="admin-box" style="max-width: 400px; margin: 40px auto;">
            <h3 style="text-align: center; margin-bottom: 20px;">Acesso Restrito</h3>
            <label>Usu√°rio Administrador</label>
            <input type="text" id="user" placeholder="Seu nome completo">
            <label>Senha</label>
            <input type="password" id="pass" placeholder="Sua senha">
            <button class="btn btn-add" onclick="login()">ENTRAR NO PAINEL</button>
        </div>

        <div id="main-screen" class="hidden">
            <button class="btn btn-save" onclick="enviarParaGithub()">üíæ SALVAR TODAS AS ALTERA√á√ïES NO SITE</button>
            
            <div class="admin-box">
                <h3 style="margin-bottom: 15px;">A√ß√µes de Membros</h3>
                <button class="btn btn-add" onclick="adicionarNovo()">+ ADICIONAR NOVO M√âDIUM / ENTIDADE</button>
            </div>

            <div id="lista-edicao">
                </div>
        </div>
    </main>

    <div id="log">Processando...</div>

    <script>
        const REPO_INFO = {
            owner: 'henriquevieiraneto',
            repo: 'TU-PAI-JOAQUIM-DE-ANGOLA-E-VO-MARIA-CONGA',
            path: 'dados.json'
        };

        let db = { mediuns: [] };
        let currentSha = "";

        function status(msg, tempo = 3000) {
            const l = document.getElementById('log');
            l.innerText = msg;
            l.style.display = 'block';
            if(tempo > 0) setTimeout(() => l.style.display = 'none', tempo);
        }

        async function login() {
            const u = document.getElementById('user').value.trim();
            const p = document.getElementById('pass').value;

            if (u === "Henrique Vieira Neto" && p === "@Hvn2009") {
                await inicializarDados();
            } else {
                alert("Usu√°rio ou senha incorretos.");
            }
        }

        async function inicializarDados() {
            let t = localStorage.getItem('gh_token');
            if(!t) {
                t = prompt("Para seguran√ßa, cole seu GitHub Token:");
                if(t) localStorage.setItem('gh_token', t);
                else return;
            }

            status("‚è≥ Sincronizando com o servidor...", 0);
            try {
                // O cache: 'no-store' e o timestamp evitam conflitos de vers√£o
                const res = await fetch(`https://api.github.com/repos/${REPO_INFO.owner}/${REPO_INFO.repo}/contents/${REPO_INFO.path}?t=${Date.now()}`, {
                    headers: { 'Authorization': `token ${t}` },
                    cache: 'no-store'
                });
                
                if(!res.ok) throw new Error();

                const data = await res.json();
                currentSha = data.sha;
                db = JSON.parse(atob(data.content));
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-screen').classList.remove('hidden');
                render();
                status("‚úÖ Sincronizado!");
            } catch (e) {
                alert("Erro ao conectar. O Token pode estar inv√°lido ou o arquivo n√£o existe.");
                localStorage.removeItem('gh_token');
                location.reload();
            }
        }

        function render() {
            const cont = document.getElementById('lista-edicao');
            cont.innerHTML = db.mediuns.length === 0 ? "<p style='text-align:center; opacity:0.5;'>Nenhum membro cadastrado.</p>" : "";
            
            db.mediuns.forEach((m, i) => {
                const item = document.createElement('div');
                item.className = 'admin-box card-edit clearfix';
                item.innerHTML = `
                    <button class="btn btn-del" onclick="remover(${i})">REMOVER</button>
                    <div style="margin-bottom: 15px;"><strong>MEMBRO #${i+1}</strong></div>
                    
                    <label>Nome Completo</label>
                    <input type="text" value="${m.nome}" oninput="db.mediuns[${i}].nome = this.value.toUpperCase()">
                    
                    <label>Fun√ß√£o / Cargo no Terreiro</label>
                    <input type="text" value="${m.cargo}" oninput="db.mediuns[${i}].cargo = this.value">
                    
                    <label>Entidade Principal (Linha de Trabalho)</label>
                    <input type="text" value="${m.entidade}" oninput="db.mediuns[${i}].entidade = this.value">
                    
                    <label>Caminho da Foto</label>
                    <input type="text" value="${m.foto}" placeholder="../img/nome.jpg" oninput="db.mediuns[${i}].foto = this.value">
                `;
                cont.appendChild(item);
            });
        }

        function adicionarNovo() {
            db.mediuns.unshift({ 
                nome: "NOVO MEMBRO", 
                cargo: "Membro", 
                entidade: "N√£o informada", 
                foto: "../img/altar.jpg" 
            });
            render();
            status("‚ú® Novo rascunho adicionado ao topo!");
        }

        function remover(i) {
            if(confirm(`Tem certeza que deseja remover ${db.mediuns[i].nome}?`)) {
                db.mediuns.splice(i, 1);
                render();
                status("üóëÔ∏è Removido da lista tempor√°ria.");
            }
        }

        async function enviarParaGithub() {
            const t = localStorage.getItem('gh_token');
            if(!t) return alert("Token n√£o encontrado.");

            status("üöÄ Gravando altera√ß√µes no site...", 0);

            try {
                const res = await fetch(`https://api.github.com/repos/${REPO_INFO.owner}/${REPO_INFO.repo}/contents/${REPO_INFO.path}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${t}`, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        message: "Atualiza√ß√£o via Painel Master: " + new Date().toLocaleString(),
                        content: btoa(JSON.stringify(db, null, 2)),
                        sha: currentSha
                    })
                });

                if(res.ok) {
                    const resData = await res.json();
                    currentSha = resData.content.sha; // Atualiza o SHA para permitir m√∫ltiplos salvamentos
                    status("‚úÖ SITE ATUALIZADO COM SUCESSO!");
                    setTimeout(() => {
                        if(confirm("Dados salvos! Deseja ver o site agora?")) {
                            window.location.href = "mediuns/index.html";
                        }
                    }, 1000);
                } else {
                    const errorMsg = await res.json();
                    alert("Erro do GitHub: " + errorMsg.message);
                }
            } catch (e) {
                alert("Erro cr√≠tico de conex√£o.");
            }
        }
    </script>
</body>
</html>