<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel Master | TU Pai Joaquim</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-box { background: var(--glass); padding: 25px; border-radius: 15px; border: 1px solid var(--glass-border); margin-bottom: 20px; }
        .card-edit { border-left: 5px solid var(--primary-neon); background: rgba(0,0,0,0.4); }
        input { width: 100%; padding: 12px; margin: 5px 0 15px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; }
        .btn { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-add { background: var(--primary-neon); color: black; margin-bottom: 20px; }
        .btn-save { background: #28a745; color: white; position: sticky; top: 10px; z-index: 100; margin-bottom: 20px; }
        .btn-del { background: #dc3545; color: white; width: auto; padding: 8px 15px; font-size: 0.7rem; float: right; }
        .foto-container { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
        .preview-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-neon); background: #222; }
        .drop-zone { flex-grow: 1; border: 2px dashed #444; border-radius: 8px; padding: 10px; text-align: center; color: #888; font-size: 0.8rem; cursor: pointer; }
        .drop-zone.active { border-color: var(--primary-neon); background: rgba(0, 212, 255, 0.1); }
        label { font-size: 0.7rem; color: var(--primary-neon); text-transform: uppercase; font-weight: bold; }
        #log { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 25px; background: var(--primary-neon); color: black; border-radius: 50px; display: none; font-weight: bold; z-index: 1000; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <header><h1>GESTÃƒO MASTER</h1></header>
    <main class="container">
        <div id="login-screen" class="admin-box" style="max-width: 400px; margin: 40px auto;">
            <input type="text" id="user" placeholder="Seu nome">
            <input type="password" id="pass" placeholder="Sua senha">
            <button class="btn btn-add" onclick="login()">ENTRAR</button>
        </div>
        <div id="main-screen" class="hidden">
            <button class="btn btn-save" onclick="enviarParaGithub()">ðŸ’¾ SALVAR NO SITE</button>
            <button class="btn btn-add" onclick="adicionarNovo()">+ ADICIONAR NOVO MÃ‰DIUM</button>
            <div id="lista-edicao"></div>
        </div>
    </main>
    <div id="log">Processando...</div>

    <script>
        const REPO_INFO = { owner: 'henriquevieiraneto', repo: 'TU-PAI-JOAQUIM-DE-ANGOLA-E-VO-MARIA-CONGA', path: 'dados.json' };
        let db = { mediuns: [] };
        let currentSha = "";

        function status(msg) {
            const l = document.getElementById('log');
            l.innerText = msg; l.style.display = 'block';
            setTimeout(() => l.style.display = 'none', 3000);
        }

        // FunÃ§Ã£o para decodificar Base64 com suporte a acentos (UTF-8)
        function b64_to_utf8(str) {
            return decodeURIComponent(escape(window.atob(str)));
        }

        async function login() {
            if (document.getElementById('user').value === "Henrique Vieira Neto" && document.getElementById('pass').value === "@Hvn2009") inicializarDados();
            else alert("Acesso negado!");
        }

        async function inicializarDados() {
            let t = localStorage.getItem('gh_token');
            if(!t) {
                t = prompt("GitHub bloqueou o token anterior. Insira um NOVO Token:");
                if(t) localStorage.setItem('gh_token', t);
                else return;
            }

            try {
                const res = await fetch(`https://api.github.com/repos/${REPO_INFO.owner}/${REPO_INFO.repo}/contents/${REPO_INFO.path}?t=${Date.now()}`, {
                    headers: { 'Authorization': `token ${t}` }, cache: 'no-store'
                });
                
                if(res.status === 401) {
                    localStorage.removeItem('gh_token');
                    alert("Token invÃ¡lido. Gere um novo no GitHub.");
                    return;
                }

                const data = await res.json();
                currentSha = data.sha;
                db = JSON.parse(b64_to_utf8(data.content));
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-screen').classList.remove('hidden');
                render();
            } catch (e) { 
                console.error(e);
                alert("Erro ao ler dados. Verifique o console."); 
            }
        }

        function render() {
            const cont = document.getElementById('lista-edicao');
            cont.innerHTML = "";
            db.mediuns.forEach((m, i) => {
                const item = document.createElement('div');
                item.className = 'admin-box card-edit';
                item.innerHTML = `
                    <button class="btn btn-del" onclick="remover(${i})">REMOVER</button>
                    <div class="foto-container">
                        <img src="${m.foto}" class="preview-img" id="prev-${i}" onerror="this.src='../img/default.jpg'">
                        <div class="drop-zone" id="drop-${i}" 
                             ondragover="event.preventDefault(); this.classList.add('active')" 
                             ondragleave="this.classList.remove('active')"
                             ondrop="handleDrop(event, ${i})">
                             Arraste uma foto aqui
                        </div>
                    </div>
                    <label>Link da Foto</label>
                    <input type="text" id="input-foto-${i}" value="${m.foto}" oninput="db.mediuns[${i}].foto = this.value; document.getElementById('prev-${i}').src = this.value">
                    <label>Nome</label>
                    <input type="text" value="${m.nome}" oninput="db.mediuns[${i}].nome = this.value.toUpperCase()">
                    <label>Cargo</label>
                    <input type="text" value="${m.cargo}" oninput="db.mediuns[${i}].cargo = this.value">
                    <label>Entidade</label>
                    <input type="text" value="${m.entidade}" oninput="db.mediuns[${i}].entidade = this.value">
                `;
                cont.appendChild(item);
            });
        }

        function handleDrop(e, index) {
            e.preventDefault();
            const html = e.dataTransfer.getData('text/html');
            const match = html.match(/src="?([^"\s]+)"?/);
            const url = match ? match[1] : e.dataTransfer.getData('text');

            if(url && url.startsWith('http')) {
                db.mediuns[index].foto = url;
                document.getElementById(`input-foto-${index}`).value = url;
                document.getElementById(`prev-${index}`).src = url;
                status("ðŸ“¸ Foto capturada!");
            }
        }

        function adicionarNovo() {
            db.mediuns.unshift({ nome: "NOVO MEMBRO", cargo: "", entidade: "", foto: "../img/default.jpg" });
            render();
        }

        function remover(i) { if(confirm("Remover?")) { db.mediuns.splice(i, 1); render(); } }

        async function enviarParaGithub() {
            const t = localStorage.getItem('gh_token');
            status("ðŸš€ Salvando...");
            try {
                // Converte para Base64 respeitando acentos
                const novoConteudo = btoa(unescape(encodeURIComponent(JSON.stringify(db, null, 2))));
                
                const res = await fetch(`https://api.github.com/repos/${REPO_INFO.owner}/${REPO_INFO.repo}/contents/${REPO_INFO.path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${t}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "CorreÃ§Ã£o de Acentos e Fotos",
                        content: novoConteudo,
                        sha: currentSha
                    })
                });
                if(res.ok) { status("âœ… SITE ATUALIZADO!"); inicializarDados(); }
            } catch (e) { alert("Erro ao salvar."); }
        }
    </script>
</body>
</html>